<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasos de Compra | ULTRA TECH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Paleta de Colores ULTRA TECH - MISMA QUE INDEX.HTML */
        :root {
            --color-primary: #E9ECEF; 
            --color-secondary: #D0AE50; 
            --color-new-background: #212529; 
            --color-card-background: #2B3035; 
            --color-white: #FFFFFF; 
            --color-whatsapp: #25d366; 
            --color-whatsapp-hover: #128c7e; 

            /* Variables de Sidebar */
            --sidebar-width-expanded: 240px;
            --sidebar-width-collapsed: 70px;
            --sidebar-bg: var(--color-card-background);
            --sidebar-text: var(--color-primary);
            --sidebar-highlight: var(--color-secondary);
        }

        /* Estilos Generales */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--color-new-background); 
            color: var(--color-primary);
            display: flex; /* Usamos flex para el layout general */
        }
        
        /* Contenedor Principal (Todo el contenido excluyendo el sidebar) */
        #main-container {
            flex-grow: 1; /* Ocupa el espacio restante */
            margin-left: var(--sidebar-width-collapsed); /* Empieza colapsado */
            padding: 30px 20px 80px 20px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #main-container.expanded {
            margin-left: var(--sidebar-width-expanded);
        }

        /* --- Estilos de SIDEBAR (Copiado de index.html) --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--sidebar-width-collapsed);
            background-color: var(--sidebar-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            transition: width 0.3s ease;
            z-index: 1050; 
            display: flex;
            flex-direction: column;
        }

        .sidebar.expanded {
            width: var(--sidebar-width-expanded);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: flex-end; 
            padding: 10px 10px;
            height: 50px; 
        }

        .sidebar.expanded .sidebar-header {
            justify-content: space-between;
        }

        .sidebar-logo {
            color: var(--sidebar-highlight);
            font-size: 20px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            display: none; 
        }

        .sidebar.expanded .sidebar-logo {
            opacity: 1;
            display: block;
        }
        
        .toggle-btn {
            background: none;
            border: none;
            color: var(--sidebar-text);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: color 0.2s, transform 0.2s;
        }
        
        .toggle-btn:hover {
            color: var(--sidebar-highlight);
        }

        .sidebar-menu {
            list-style: none;
            padding: 10px 0;
            margin: 0;
            flex-grow: 1;
        }

        .menu-item {
            padding: 12px 0;
            cursor: pointer;
        }

        .menu-item a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--sidebar-text);
            padding: 10px 15px;
            transition: background-color 0.2s, color 0.2s;
            overflow: hidden;
        }
        
        .menu-item a:hover {
            background-color: #3B4249; 
            color: var(--sidebar-highlight);
        }
        
        .menu-item i {
            width: 30px; 
            text-align: center;
            font-size: 18px;
            color: var(--sidebar-highlight);
        }

        .menu-item span {
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }
        
        .sidebar.expanded .menu-item span {
            opacity: 1;
        }
        
        .menu-item.active a {
            background-color: var(--sidebar-highlight);
            color: var(--color-new-background);
            font-weight: bold;
        }
        .menu-item.active i {
            color: var(--color-new-background);
        }

        @media (max-width: 768px) {
            #main-container {
                margin-left: 0; 
            }
            .sidebar {
                width: 0;
                box-shadow: none; 
            }
            .sidebar.expanded {
                width: var(--sidebar-width-expanded); 
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            
            .sidebar-header {
                justify-content: space-between; 
            }
            .sidebar-logo {
                opacity: 1;
                display: block;
            }

            .sidebar .menu-item span {
                opacity: 1;
            }
        }
        /* --- FIN Estilos de SIDEBAR --- */


        /* Título Principal */
        .main-title {
            text-align: center;
            margin-bottom: 30px;
            padding: 0 0px;
            width: 100%;
        }
        .main-title h1 {
            color: var(--color-primary); 
            font-size: 36px;
            margin: 0;
            padding: 0;
            border-bottom: none;
        }
        .main-title .underline {
            display: block;
            width: 180px; 
            height: 3px;
            background-color: var(--color-secondary); 
            margin: 5px auto 0 auto;
            border-radius: 2px;
        }
        
        /* Botón de Volver */
        .back-button {
            display: inline-block;
            padding: 10px 15px;
            background-color: #495057; /* Gris oscuro para el botón */
            color: var(--color-primary);
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .back-button:hover {
            background-color: #6C757D;
        }


        /* Contenedor de Pasos */
        .purchase-steps-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--color-card-background);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center; 
        }

        /* Estilos de Pasos */
        .step {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #404B55;
            text-align: left; 
        }
        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            text-align: center; 
        }
        .step h2 {
            font-size: 20px;
            color: var(--color-secondary);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Estilo del Dropdown (CORREGIDO) */
        #payment-method-select {
            padding: 10px 40px 10px 15px; 
            border-radius: 5px;
            border: 1px solid var(--color-secondary);
            background-color: #3B4249;
            color: var(--color-primary);
            font-size: 16px;
            width: fit-content; 
            min-width: 250px; 
            max-width: 100%; 
            cursor: pointer;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23E9ECEF%22%20d%3D%22M287%2069.4l-14.9-14.9c-2.3-2.3-4.9-3.4-7.6-3.4-2.7%200-5.3%201.1-7.7%203.4L146.2%20170.8%2029.8%2054.4c-4.7-4.7-12.2-4.7-16.9%200l-14.9%2014.9c-4.7%204.7-4.7%2012.2%200%2016.9l133.5%20133.5c2.3%202.3%204.9%203.4%207.6%203.4s5.3-1.1%207.7-3.4l133.5-133.5c4.7-4.6%204.7-12.2%200-16.9z%22%2F%3E%3C%2Fsvg%3E'); 
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
        }
        
        /* Contenedor Dinámico de Cuenta */
        #account-info-container {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--color-secondary);
            border-radius: 5px;
            background-color: #3B4249;
        }
        #account-info-container p {
            margin: 5px 0;
            font-size: 14px;
        }
        .product-details {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Estilos del Botón de WhatsApp */
        .whatsapp-transfer-btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--color-whatsapp); 
            color: var(--color-white);
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
        }
        .whatsapp-transfer-btn:hover {
            background-color: var(--color-whatsapp-hover);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

    <!-- Menú Lateral -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-logo">ULTRA TECH</span>
            <button class="toggle-btn" id="sidebar-toggle">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu" id="sidebar-menu">
            <!-- Los elementos del menú se cargarán aquí con JS -->
        </ul>
    </nav>

    <!-- Contenedor Principal de la Página -->
    <div id="main-container">

        <div class="main-title">
            <h1>PASOS A SEGUIR PARA CONCRETAR LA COMPRA</h1>
            <span class="underline"></span>
        </div>

        <div class="purchase-steps-container">

            <a href="index.html" class="back-button">
                <i class="fa-solid fa-arrow-left"></i> Volver a la Lista de Productos
            </a>
            
            <div class="product-details" id="product-display"></div>
            
            <div class="step">
                <h2>1. Seleccionar Método de Pago</h2>
                <select id="payment-method-select"></select>
            </div>

            <div class="step">
                <h2>2. Realizar el Pago</h2>
                <p id="payment-description">...</p>
                
                <div id="account-info-container">
                    </div>
            </div>

            <div class="step">
                <h2>3. Informar y Confirmar</h2>
                <a 
                    href="#" 
                    class="whatsapp-transfer-btn"
                    id="whatsapp-btn"
                    target="_blank"
                >
                    <i class="fa-brands fa-whatsapp"></i> Informar Transferencia
                </a>
            </div>
        </div>
        
    </div>
    <!-- Fin Contenedor Principal -->

    <script src="utils/priceFormatter.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initPurchasePage);

        let PAYMENT_METHODS_DATA = {};
        let productDetails = {};
        let CONTACT_PHONE = ''; 
        let sidebarConfig = []; // Variable para el sidebar

        async function initPurchasePage() {
            // 1. Inicializar Sidebar
            await initSidebar();
            
            // 2. Cargar el número de teléfono
            try {
                const contactResponse = await fetch('config/contact_info.json');
                if (!contactResponse.ok) throw new Error("No se pudo cargar config/contact_info.json");
                const contactData = await contactResponse.json();
                CONTACT_PHONE = contactData.phone;
            } catch (error) {
                console.error("Error al cargar el número de contacto:", error);
            }


            // 3. Obtener detalles del producto de la URL
            const params = new URLSearchParams(window.location.search);
            productDetails = {
                product: params.get('product') || 'Producto Desconocido',
                priceTransferencia: params.get('priceT') || 'N/A',
                priceUSDT: params.get('priceU') || 'N/A'
            };

            document.getElementById('product-display').textContent = 
                `Artículo seleccionado: ${productDetails.product}`;

            // 4. Cargar métodos de pago
            try {
                const response = await fetch('config/payment_methods.json'); 
                if (!response.ok) throw new Error("No se pudo cargar config/payment_methods.json");
                PAYMENT_METHODS_DATA = await response.json();
                
                populatePaymentDropdown();
                // 5. Cargar la información inicial (Transferencia por defecto o la primera opción disponible)
                const firstMethod = Object.keys(PAYMENT_METHODS_DATA)[0];
                handlePaymentMethodChange(firstMethod); 

                // 6. Configurar listener para el dropdown
                document.getElementById('payment-method-select').addEventListener('change', (e) => {
                    handlePaymentMethodChange(e.target.value);
                });

            } catch (error) {
                console.error("Error al cargar la configuración de pagos:", error);
                const container = document.querySelector('.purchase-steps-container');
                if (container) {
                     container.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                }
            }
        }

        // --- FUNCIONES DEL SIDEBAR (Copiado de index.html) ---
        async function initSidebar() {
            try {
                const response = await fetch('config/sidebar_config.json');
                if (!response.ok) throw new Error('No se pudo cargar sidebar_config.json');
                sidebarConfig = await response.json();
                renderSidebar();
                
                const sidebar = document.getElementById('sidebar');
                const mainContainer = document.getElementById('main-container');
                const toggleBtn = document.getElementById('sidebar-toggle');
                
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('expanded');
                    mainContainer.classList.toggle('expanded');
                });

                // Establecer el estado inicial (colapsado) para escritorio, expandido para móvil.
                if (window.innerWidth >= 768) {
                    sidebar.classList.remove('expanded');
                    mainContainer.classList.remove('expanded');
                } else {
                    // En móvil, empezar colapsado (width: 0), pero al hacer click expandir
                }

            } catch (error) {
                console.error("Error al inicializar el sidebar:", error);
            }
        }
        
        function renderSidebar() {
            const menuContainer = document.getElementById('sidebar-menu');
            menuContainer.innerHTML = '';
            const currentPage = window.location.pathname.split('/').pop();
            
            sidebarConfig.forEach(item => {
                const listItem = document.createElement('li');
                listItem.classList.add('menu-item');
                
                if (item.url === currentPage) {
                    listItem.classList.add('active');
                }
                
                listItem.innerHTML = `
                    <a href="${item.url}">
                        <i class="fa-solid ${item.icon}"></i>
                        <span>${item.label}</span>
                    </a>
                `;
                menuContainer.appendChild(listItem);
            });
        }
        // --- FIN FUNCIONES DEL SIDEBAR ---


        /**
         * Rellena el dropdown con las opciones de pago.
         */
        function populatePaymentDropdown() {
            const select = document.getElementById('payment-method-select');
            select.innerHTML = '';
            for (const key in PAYMENT_METHODS_DATA) {
                const option = document.createElement('option');
                option.value = key; 
                option.textContent = PAYMENT_METHODS_DATA[key].title;
                select.appendChild(option);
            }
        }

        /**
         * Actualiza la información de la cuenta y el botón de WhatsApp.
         */
        function handlePaymentMethodChange(methodKey) {
            const data = PAYMENT_METHODS_DATA[methodKey];
            const infoContainer = document.getElementById('account-info-container');
            const descriptionElement = document.getElementById('payment-description');
            const whatsappBtn = document.getElementById('whatsapp-btn');
            
            descriptionElement.textContent = data.description;
            
            let htmlContent = '';
            let price = '';
            let whatsappText = '';
            
            if (methodKey === 'TRANSFERENCIA') {
                price = productDetails.priceTransferencia;
                const formattedPrice = formatARS(price); 
                const acc = data.account;
                htmlContent = `
                    <p><strong>Total a pagar: ${formattedPrice}</strong></p>
                    <p><strong>CBU:</strong> ${acc.cbu}</p>
                    <p><strong>Alias:</strong> ${acc.alias}</p>
                    <p><strong>Banco:</strong> ${acc.banco}</p>
                    <p><strong>Titular:</strong> ${acc.nombre}</p>
                `;
                whatsappText = `Hola! Acabo de hacer una transferencia por ${formattedPrice} para la compra de ${productDetails.product}. Adjunto comprobante.`;

            } else if (methodKey === 'USDT') {
                price = productDetails.priceUSDT;
                const formattedPrice = formatUSDT(price);
                const acc = data.account;
                htmlContent = `
                    <p><strong>Total a pagar: ${formattedPrice}</strong></p>
                    <p><strong>Wallet (Address):</strong> ${acc.address}</p>
                    <p><strong>Red/Network:</strong> ${acc.network}</p>
                `;
                whatsappText = `Hola! Acabo de enviar ${formattedPrice} para la compra de ${productDetails.product}. Adjunto comprobante.`;
            }

            infoContainer.innerHTML = htmlContent;

            // Actualizar el botón de WhatsApp con el número de contacto cargado
            const encodedText = encodeURIComponent(whatsappText);
            
            if (CONTACT_PHONE) {
                whatsappBtn.href = `https://wa.me/${CONTACT_PHONE}?text=${encodedText}`;
            } else {
                whatsappBtn.href = "#"; // Enlace inactivo si el teléfono no se cargó
            }
        }
    </script>
</body>
</html>